<script>
document.addEventListener('DOMContentLoaded', async () => {
  const vehicleList = document.getElementById('vehicleList');
  const form = document.getElementById('vehicleForm');
  const adminFormContainer = document.getElementById('adminFormContainer');
  const messageBox = document.getElementById('messageBox');
  const loginBtn = document.getElementById('loginBtn');

  // Check if user is admin
  async function checkAdmin() {
    try {
      const res = await fetch('https://ckrp-backend.onrender.com/is-whitelisted');
      const result = await res.json();
      return result.allowed;
    } catch { return false; }
  }

  const isAdmin = await checkAdmin();
  if (isAdmin) {
    loginBtn.style.display = 'none';
    messageBox.textContent = "Logged in as authorized admin";
    adminFormContainer.style.display = 'block';
  } else {
    loginBtn.style.display = 'block';
    messageBox.textContent = "Log in to add vehicles";
  }

  loginBtn.addEventListener('click', () => window.location.href = '/login');

  // Load vehicles
  async function loadVehicles() {
    try {
      const res = await fetch('https://ckrp-backend.onrender.com/vehicles');
      const vehicles = await res.json();
      vehicleList.innerHTML = '';
      if (vehicles.length === 0) {
        vehicleList.innerHTML = '<p>No vehicles listed yet.</p>';
        return;
      }
      vehicles.forEach(v => {
        const div = document.createElement('div');
        div.className = 'vehicle-card';
        div.innerHTML = `
          <div>
            <strong>${v.name}</strong><br>
            Miles: ${v.miles}<br>
            Condition: ${v.condition}<br>
            Added by: ${v.added_by}
          </div>
          ${v.image ? `<img src="${v.image}" alt="${v.name}">` : ''}
          ${isAdmin ? `<button class="delete-btn" data-id="${v.id}">Delete</button>` : ''}
        `;
        vehicleList.appendChild(div);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const res = await fetch(`https://ckrp-backend.onrender.com/vehicles/${id}`, { method: 'DELETE' });
          const result = await res.json();
          messageBox.textContent = result.message || 'Deleted';
          await loadVehicles();
        });
      });
    } catch (err) {
      console.error('Error loading vehicles:', err);
      vehicleList.innerHTML = '<p style="color:red;">Failed to load vehicles.</p>';
    }
  }

  await loadVehicles();

  // Submit vehicle
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const vehicle = {
      name: document.getElementById('name').value.trim(),
      miles: parseInt(document.getElementById('miles').value),
      condition: document.getElementById('condition').value.trim(),
      image: document.getElementById('image').value.trim()
    };
    try {
      const res = await fetch('https://ckrp-backend.onrender.com/vehicles', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(vehicle)
      });
      const result = await res.json();
      messageBox.textContent = result.message || 'Added';
      form.reset();
      await loadVehicles();
    } catch (err) {
      console.error('Submission error:', err);
      alert('Failed to submit vehicle. Check console for details.');
    }
  });
});
</script>
